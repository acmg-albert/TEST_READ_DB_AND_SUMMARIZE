**从****Supabase数据库读数据展示交互式汇总及图表页面 – Apartmentlist 空置率模块**

类似历史租金数据汇总及图表页面，这个Web App的空置率数据也要展示两个有交互功能的页面。一个是汇总页面，第一层级，另一个是按照地区展示的页面，第二层级。第一层级汇总trailing 3 months的空置率和一年前同期相比的变化百分比10大地区（或3大州），第二层级页面展示选定某个地区的空置率及其变化曲线，以及趋势估测。第一层级页面有一个专门的按钮链接连第二层级页面，第二层级的页面也有一个专门的按钮链接返回第一层级的页面。

汇总后图表曲线背后的数据从Supabase的REAL_ANALYTICS_DB数据库数据视图读入，数据库URL和API key信息为用保护隐私的方法链接，具体参考项目内租金数据的连接。空置率的数据视图为：apartment_list_vacancy_index_view。这里要注意的是，之前做租金数据汇总及图表页面的时候，代码脚本文件以及里面很多代码的部分的命名没有专门标明类似apartmentlist_rent这种能区别到底做的是什么数据的代码，但是从现在做空置率的数据汇总及图表的页面开始，我们都要具体区别标明，代码规范化，并且文件脚本和目录结构也都要规范话。但是先不要mess up已经做好的租金数据汇总及图表的页面的脚本。

以下是具体页面需求。

**第一层级汇总页面细节需求：**

这个页面要展示trailing 3 months的空置率和一年前同期相比增长百分比最大的10大地区（或3大州）和增长百分比最小的10大地区（或3大州）（负增长）。这个计算百分比定义为：trailing 3个月每个月租金和一年前的同月租金相比计算变化百分比，然后把三个变化百分比做平均。比如说，如果trailing 3 months是：2015年1月，2024年12月，2024年11月，那么就分别和2024年1月，2023年12月，2023年11月相比计算变化百分比，然后做平均。用数据表视图的vacancy_index做计算。这个汇总需要给汇总出：

*   3大空置率上升百分比最大的州
*   3大空置率上升百分比最小的州（负增长）
*   10大空置率上升百分比最大的都会区
*   10大空置率上升百分比最小的都会区（负增长）
*   10大空置率上升百分比最大的城市
*   10大空置率上升百分比最小的城市（负增长）

这里要注意：数据表里的代表年月的列year_month是character string字符串，“YYYY_MM”的形式，比如2025年1月就是“2025_01”，所以处理数据的时候要小心。

每个汇总表格式如下示意：

| Location | YYYY-MM 1 Vacancy (This is the most recent month in database) | YYYY-MM 2 Vacancy (This is the second recent month in database) | YYYY-MM 3 Vacancy (This is the third recent month in database) | Trailing 3 Month YOY Vacancy Change % |
| --- | --- | --- | --- | --- |
| Top 1 location name | xxx | xxx | xxx | xx% |
| Top 2 location name | xxx | xxx | xxx | xx% |
| … | … | … | … | … |

汇总表的格式和项目里租金数据汇总表的类似，包括交互功能也都类似。

**第二层级按照地区展示的细节页面细节需求：**

第二层级页面具体展示选定一个地区的空置率在时间轴上的曲线，以及年同比变化百分比。这个页面左上角要有有两个下拉搜索选项框，第一个框是下拉选择和搜索地区的颗粒度，对应数据表的location_type，有: National，State，Metro，County，City；第二个框是下拉选择和搜索具体地区名字，对应数据表的：location_name；选择好地区的颗粒度之后具体地区会能下拉或者搜索数据表里有的对应颗粒度的地区名字。

选择好地区之后，页面上展示一个双坐标时间序列交互图表，这个图上显示该地区在数据表里最早的年月到数据表里最近的年月的空置率曲线和空置率年同比变化百分比的柱状图，左边的纵坐标对应空置率，右边的纵坐标对应变化百分比，横轴为时间轴，并且横轴下方能有功能拖动时间范围，那样能让图上显示不同的时间范围的空置率曲线和变化百分比柱状图。如果某个年月空置率数据有数据缺失或者空置率显示为0，这类情况就是数据invalid，那对应的月份的点和连线就不画出来，相应的变化百分比柱子也没有。

空置率汇总及按照地区的图表页面和租金汇总及图表页面功能实现非常相似，所以可以参考租金模块的那两个页面。这里的前后端也是一致的，图表设置，及在电脑和手机或者ipad上看的页面布局都是对的。